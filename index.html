<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snake Game</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
    }

    #game-wrapper {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }

    #game-container {
      text-align: center;
    }

    canvas {
      display: block;
      margin: 0 auto;
      border: 1px solid #444;
      background: #000;
    }

    #info {
      margin-top: 8px;
      font-size: 14px;
      color: #ccc;
      max-width: 520px;
    }

    #side-panel {
      min-width: 220px;
      max-width: 260px;
      font-size: 14px;
    }

    #key-panel {
      border: 1px solid #444;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 12px;
      background: #111;
      display: none; /* hidden on selection screen */
    }

    #key-panel h2 {
      font-size: 16px;
      margin: 0 0 8px 0;
      text-align: center;
    }

    .key-row {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }

    .key-box {
      width: 16px;
      height: 16px;
      border-radius: 2px;
      margin-right: 8px;
      border: 1px solid #222;
    }

    .food-box      { background: #ff0000; }   /* red */
    .speed-box     { background: #800080; }   /* purple */
    .teleport-box  { background: #90ee90; }   /* light green */
    .slow-box      { background: #ffff00; }   /* yellow */
    .double-box    { background: #0000ff; }   /* blue */

    #side-help {
      border: 1px solid #444;
      border-radius: 8px;
      padding: 10px 12px;
      background: #111;
    }

    #side-help h3 {
      font-size: 15px;
      margin: 0 0 6px 0;
      text-align: center;
    }

    #side-help ul {
      margin: 0;
      padding-left: 18px;
    }

    #side-help li {
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div id="game-wrapper">
    <div id="game-container">
      <!-- 17 * 30 = 510; plus 50 for score area => 560 -->
      <canvas id="game" width="510" height="560"></canvas>
      <div id="info">
        <div>On the selection screen: LEFT / RIGHT to choose snake color, UP / DOWN to choose difficulty, SPACE to start.</div>
        <div>In game: Arrow Keys or WASD to move, M to toggle music, SPACE to return to the selection screen after Game Over.</div>
      </div>
    </div>

    <div id="side-panel">
      <div id="key-panel">
        <h2>Power-Up Key</h2>
        <div class="key-row">
          <span class="key-box food-box"></span>
          <span>Red – Food: grow + score.</span>
        </div>
        <div class="key-row">
          <span class="key-box speed-box"></span>
          <span>Purple – Speed Up: faster for a short time.</span>
        </div>
        <div class="key-row">
          <span class="key-box slow-box"></span>
          <span>Yellow – Slow Down: slower for a short time.</span>
        </div>
        <div class="key-row">
          <span class="key-box teleport-box"></span>
          <span>Light Green – Teleport: jump to a random safe cell.</span>
        </div>
        <div class="key-row">
          <span class="key-box double-box"></span>
          <span>Blue – Double Growth: extra length from the tail.</span>
        </div>
        <p style="margin-top:8px; font-size:12px; color:#aaa;">
          Easy: only red food. Medium: all except green teleport. Hard: all power-ups.
        </p>
      </div>

      <div id="side-help">
        <h3>Difficulty Modes</h3>
        <ul>
          <li><b>Easy</b> – Only red food squares.</li>
          <li><b>Medium</b> – All power-ups except green teleport.</li>
          <li><b>Hard</b> – All power-ups, including green teleport.</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // ====== BASIC CONFIG (matches your original logic) ======
    const GRID_SIZE = 17;
    const CELL_SIZE = 30;
    const WIDTH = GRID_SIZE * CELL_SIZE;
    const HEIGHT = GRID_SIZE * CELL_SIZE + 50;

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const keyPanel = document.getElementById("key-panel");

    const Direction = {
      UP:    { x:  0, y: -1 },
      DOWN:  { x:  0, y:  1 },
      LEFT:  { x: -1, y:  0 },
      RIGHT: { x:  1, y:  0 }
    };

    const POWERUP_TYPES = {
      FOOD: "FOOD",
      SPEED_UP: "SPEED_UP",
      TELEPORT: "TELEPORT",
      SLOW_DOWN: "SLOW_DOWN",
      DOUBLE_GROWTH: "DOUBLE_GROWTH"
    };

    // Snake color schemes (avatar choices)
    const SNAKE_COLORS = [
      { name: "Classic Green", head: [0, 255, 0], body: [0, 200, 0] },
      { name: "Ocean Blue",   head: [0, 150, 255], body: [0, 100, 200] },
      { name: "Fire Red",     head: [255, 50, 50], body: [200, 0, 0] },
      { name: "Royal Purple", head: [180, 0, 255], body: [120, 0, 180] },
      { name: "Sunset Orange",head: [255, 165, 0], body: [200, 100, 0] },
      { name: "Bubblegum Pink", head: [255, 192, 203], body: [255, 100, 150] },
      { name: "Cyber Cyan",   head: [0, 255, 255], body: [0, 180, 180] },
      { name: "Golden",       head: [255, 215, 0], body: [218, 165, 32] }
    ];

    const COLORS = {
      BLACK: [0, 0, 0],
      WHITE: [255, 255, 255],
      RED: [255, 0, 0],
      GRAY: [50, 50, 50],
      PURPLE: [128, 0, 128],
      YELLOW: [255, 255, 0],
      BLUE: [0, 0, 255],
      LIGHT_GREEN: [144, 238, 144]
    };

    function rgb(arr) {
      return `rgb(${arr[0]}, ${arr[1]}, ${arr[2]})`;
    }

    // ====== DIFFICULTY ======
    const DIFFICULTY_NAMES = ["Easy", "Medium", "Hard"];
    let difficultyIndex = 0;           // 0=Easy,1=Medium,2=Hard
    function currentDifficultyName() {
      return DIFFICULTY_NAMES[difficultyIndex];
    }

    // ====== GAME STATE ======
    let inSelectionScreen = true;
    let selectedColorIndex = 0;

    let snake = [];
    let direction = Direction.RIGHT;
    let nextDirection = Direction.RIGHT;

    let currentPowerup = POWERUP_TYPES.FOOD;
    let powerupPos = null;

    let score = 0;
    const baseSpeed = 10;
    let currentSpeed = baseSpeed;
    let speedBoostEndTime = 0;

    let gameOver = false;

    let lastStepTime = 0;

    // ====== MUSIC ======
    let bgMusic = null;
    let musicLoaded = false;
    let userInteracted = false;

    try {
      bgMusic = new Audio("background_music.mp3");
      bgMusic.loop = true;
      musicLoaded = true;
    } catch (e) {
      musicLoaded = false;
    }

    function toggleMusic() {
      if (!bgMusic || !musicLoaded) return;
      if (bgMusic.paused) {
        bgMusic.play().catch(() => {});
      } else {
        bgMusic.pause();
      }
    }

    // ====== HELPERS ======
    function randomEmptyCell() {
      while (true) {
        const x = Math.floor(Math.random() * GRID_SIZE);
        const y = Math.floor(Math.random() * GRID_SIZE);
        if (!snake.some(seg => seg.x === x && seg.y === y)) {
          return { x, y };
        }
      }
    }

    function spawnItem() {
      powerupPos = randomEmptyCell();
    }

    function spawnNewPowerup() {
      // Easy: only red (FOOD)
      // Medium: FOOD + SPEED_UP + SLOW_DOWN + DOUBLE_GROWTH (no TELEPORT)
      // Hard: all power-ups including TELEPORT
      let choices = [POWERUP_TYPES.FOOD];

      const diffName = currentDifficultyName();
      if (diffName === "Medium" || diffName === "Hard") {
        choices.push(
          POWERUP_TYPES.SPEED_UP,
          POWERUP_TYPES.SLOW_DOWN,
          POWERUP_TYPES.DOUBLE_GROWTH
        );
      }
      if (diffName === "Hard") {
        choices.push(POWERUP_TYPES.TELEPORT);
      }

      const idx = Math.floor(Math.random() * choices.length);
      currentPowerup = choices[idx];
      spawnItem();
    }

    function getPowerupColor() {
      switch (currentPowerup) {
        case POWERUP_TYPES.FOOD:          return rgb(COLORS.RED);
        case POWERUP_TYPES.SPEED_UP:      return rgb(COLORS.PURPLE);
        case POWERUP_TYPES.TELEPORT:      return rgb(COLORS.LIGHT_GREEN);
        case POWERUP_TYPES.SLOW_DOWN:     return rgb(COLORS.YELLOW);
        case POWERUP_TYPES.DOUBLE_GROWTH: return rgb(COLORS.BLUE);
        default:                          return rgb(COLORS.RED);
      }
    }

    // ====== GAME SETUP / RESET ======
    function startGame() {
      const startX = Math.floor(GRID_SIZE / 2);
      const startY = Math.floor(GRID_SIZE / 2);
      snake = [
        { x: startX, y: startY },
        { x: startX - 1, y: startY },
        { x: startX - 2, y: startY }
      ];

      direction = Direction.RIGHT;
      nextDirection = Direction.RIGHT;
      score = 0;
      gameOver = false;
      currentSpeed = baseSpeed;
      speedBoostEndTime = 0;

      currentPowerup = POWERUP_TYPES.FOOD;
      spawnItem(); // first item is always FOOD
      inSelectionScreen = false;

      lastStepTime = performance.now();

      // show key panel only while playing
      keyPanel.style.display = "block";

      if (bgMusic && musicLoaded && userInteracted) {
        bgMusic.volume = 0.5;
        bgMusic.play().catch(() => {});
      }
    }

    function resetToSelectionScreen() {
      inSelectionScreen = true;
      gameOver = false;
      // hide key panel on selection screen
      keyPanel.style.display = "none";
      if (bgMusic && musicLoaded) {
        bgMusic.pause();
      }
    }

    // ====== INPUT ======
    document.addEventListener("keydown", (e) => {
      userInteracted = true;

      // Selection screen controls
      if (inSelectionScreen) {
        if (e.key === "ArrowLeft") {
          selectedColorIndex =
            (selectedColorIndex - 1 + SNAKE_COLORS.length) % SNAKE_COLORS.length;
        } else if (e.key === "ArrowRight") {
          selectedColorIndex =
            (selectedColorIndex + 1) % SNAKE_COLORS.length;
        } else if (e.key === "ArrowUp") {
          difficultyIndex =
            (difficultyIndex - 1 + DIFFICULTY_NAMES.length) % DIFFICULTY_NAMES.length;
        } else if (e.key === "ArrowDown") {
          difficultyIndex =
            (difficultyIndex + 1) % DIFFICULTY_NAMES.length;
        } else if (e.key === " " || e.code === "Space") {
          startGame();
        }
        return;
      }

      // In-game controls
      if (e.key === "ArrowUp" || e.key === "w" || e.key === "W") {
        if (direction !== Direction.DOWN) nextDirection = Direction.UP;
      } else if (e.key === "ArrowDown" || e.key === "s" || e.key === "S") {
        if (direction !== Direction.UP) nextDirection = Direction.DOWN;
      } else if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") {
        if (direction !== Direction.RIGHT) nextDirection = Direction.LEFT;
      } else if (e.key === "ArrowRight" || e.key === "d" ||
