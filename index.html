<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snake Game</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #b39dff 0%, #7c4dff 40%, #4b2bb3 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
      color: #111;
    }

    /* White card that holds everything */
    #game-container {
      display: flex;
      gap: 30px;
      align-items: flex-start;
      padding: 24px 28px;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.7);
    }

    #canvas-section {
      text-align: center;
    }

    canvas {
      display: block;
      margin: 0 auto;
      border: 2px solid #444;
      background: #000;
    }

    #info {
      margin-top: 12px;
      font-size: 14px;
      color: #444;
      line-height: 1.5;
    }

    /* Shared style for the side cards (legend + controls) */
    .side-card {
      background: #fdfdfd;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 16px 18px;
      width: 230px;
      color: #111;
      font-size: 14px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .side-card h2 {
      margin: 0 0 12px 0;
      font-size: 18px;
      color: #222;
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
    }

    /* Power-up legend-specific styles */
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      border: 1px solid #666;
      flex-shrink: 0;
    }

    .legend-text {
      line-height: 1.3;
    }

    .legend-title {
      font-weight: bold;
      color: #000;
    }

    .legend-desc {
      color: #555;
      font-size: 12px;
    }

    .section-divider {
      border-top: 1px solid #ddd;
      margin: 14px 0;
    }

    /* Controls card styles */
    #controls {
      width: 210px;
    }

    .control-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .key-box {
      width: 26px;
      height: 26px;
      border-radius: 4px;
      border: 1px solid #666;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      margin-right: 10px;
      background: #f3f3f3;
      box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.7);
    }

    .control-label-main {
      font-weight: 600;
      color: #111;
    }

    .control-label-sub {
      font-size: 12px;
      color: #555;
    }
  </style>
</head>
<body>
  <div id="game-container">

    <!-- LEFT: controls key -->
    <div id="controls" class="side-card">
      <h2>Controls</h2>

      <div class="control-row">
        <div class="key-box">W</div>
        <div>
          <div class="control-label-main">Move Up</div>
          <div class="control-label-sub">Hold to keep going upward</div>
        </div>
      </div>

      <div class="control-row">
        <div class="key-box">S</div>
        <div>
          <div class="control-label-main">Move Down</div>
          <div class="control-label-sub">Hold to keep going downward</div>
        </div>
      </div>

      <div class="control-row">
        <div class="key-box">A</div>
        <div>
          <div class="control-label-main">Move Left</div>
          <div class="control-label-sub">Turn the snake left</div>
        </div>
      </div>

      <div class="control-row">
        <div class="key-box">D</div>
        <div>
          <div class="control-label-main">Move Right</div>
          <div class="control-label-sub">Turn the snake right</div>
        </div>
      </div>

      <div class="section-divider"></div>

      <div class="control-row">
        <div class="key-box">C</div>
        <div>
          <div class="control-label-main">Continue</div>
          <div class="control-label-sub">Reset snake to center, keep size & score</div>
        </div>
      </div>

      <div class="control-row">
        <div class="key-box">M</div>
        <div>
          <div class="control-label-main">Toggle Music</div>
        </div>
      </div>

      <div class="control-row">
        <div class="key-box">R</div>
        <div>
          <div class="control-label-main">New Selection</div>
          <div class="control-label-sub">Return to avatar + difficulty screen</div>
        </div>
      </div>

      <div class="control-row">
        <div class="key-box">‚ê£</div>
        <div>
          <div class="control-label-main">Start / Replay</div>
          <div class="control-label-sub">Start game or replay after Game Over</div>
        </div>
      </div>
    </div>

    <!-- CENTER: game canvas -->
    <div id="canvas-section">
      <canvas id="game" width="510" height="560"></canvas>
      <div id="info">
        <div>Selection: A/D = color, W/S = difficulty, SPACE = start</div>
        <div>In game: W/A/S/D to move, C = continue from center, M = music, SPACE after Game Over = restart, R = new selection</div>
      </div>
    </div>

    <!-- RIGHT: power-up legend -->
    <div id="legend" class="side-card">
      <h2>Power-Ups</h2>

      <div class="legend-item">
        <div class="legend-color" style="background: #FF0000;"></div>
        <div class="legend-text">
          <div class="legend-title">Red - Food</div>
          <div class="legend-desc">Grow by 1 segment</div>
        </div>
      </div>

      <div class="legend-item">
        <div class="legend-color" style="background: #800080;"></div>
        <div class="legend-text">
          <div class="legend-title">Purple - Speed Up</div>
          <div class="legend-desc">+0.2 speed for 5 sec</div>
        </div>
      </div>

      <div class="legend-item">
        <div class="legend-color" style="background: #90EE90;"></div>
        <div class="legend-text">
          <div class="legend-title">Green - Teleport</div>
          <div class="legend-desc">Random teleport</div>
        </div>
      </div>

      <div class="legend-item">
        <div class="legend-color" style="background: #FFFF00;"></div>
        <div class="legend-text">
          <div class="legend-title">Yellow - Slow Down</div>
          <div class="legend-desc">-0.2 speed for 5 sec</div>
        </div>
      </div>

      <div class="legend-item">
        <div class="legend-color" style="background: #0000FF;"></div>
        <div class="legend-text">
          <div class="legend-title">Blue - Double Growth</div>
          <div class="legend-desc">Grow by 2 segments</div>
        </div>
      </div>

      <div class="section-divider"></div>

      <h2 style="margin-top: 8px;">Difficulty</h2>
      <div style="font-size: 13px; line-height: 1.6; color: #333;">
        <div style="margin-bottom: 8px;">
          <strong style="color: #4CAF50;">Easy:</strong> Only red food
        </div>
        <div style="margin-bottom: 8px;">
          <strong style="color: #FFA500;">Medium:</strong> All except green
        </div>
        <div style="margin-bottom: 2px;">
          <strong style="color: #F44336;">Hard:</strong> All power-ups
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==== CONFIGURATION ====
    const GRID_SIZE = 17;
    const CELL_SIZE = 30;
    const WIDTH = GRID_SIZE * CELL_SIZE;
    const HEIGHT = GRID_SIZE * CELL_SIZE + 50;

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const Direction = {
      UP:    { x:  0, y: -1 },
      DOWN:  { x:  0, y:  1 },
      LEFT:  { x: -1, y:  0 },
      RIGHT: { x:  1, y:  0 }
    };

    const POWERUP_TYPES = {
      FOOD: "FOOD",
      SPEED_UP: "SPEED_UP",
      TELEPORT: "TELEPORT",
      SLOW_DOWN: "SLOW_DOWN",
      DOUBLE_GROWTH: "DOUBLE_GROWTH"
    };

    // Difficulty modes
    const DIFFICULTIES = [
      {
        name: "Easy",
        description: "Only red food",
        id: "EASY",
        color: [144, 238, 144]
      },
      {
        name: "Medium",
        description: "All except green",
        id: "MEDIUM",
        color: [255, 255, 0]
      },
      {
        name: "Hard",
        description: "All power-ups",
        id: "HARD",
        color: [255, 102, 102]
      }
    ];

    // Snake color schemes
    const SNAKE_COLORS = [
      { name: "Classic Green", head: [0, 255, 0], body: [0, 200, 0] },
      { name: "Ocean Blue",   head: [0, 150, 255], body: [0, 100, 200] },
      { name: "Fire Red",     head: [255, 50, 50], body: [200, 0, 0] },
      { name: "Royal Purple", head: [180, 0, 255], body: [120, 0, 180] },
      { name: "Sunset Orange",head: [255, 165, 0], body: [200, 100, 0] },
      { name: "Bubblegum Pink", head: [255, 192, 203], body: [255, 100, 150] },
      { name: "Cyber Cyan",   head: [0, 255, 255], body: [0, 180, 180] },
      { name: "Golden",       head: [255, 215, 0], body: [218, 165, 32] }
    ];

    const COLORS = {
      BLACK: [0, 0, 0],
      WHITE: [255, 255, 255],
      RED: [255, 0, 0],
      GRAY: [50, 50, 50],
      PURPLE: [128, 0, 128],
      YELLOW: [255, 255, 0],
      BLUE: [0, 0, 255],
      LIGHT_GREEN: [144, 238, 144]
    };

    function rgb(arr) {
      return `rgb(${arr[0]}, ${arr[1]}, ${arr[2]})`;
    }

    // ==== GAME STATE ====
    let inSelectionScreen = true;
    let selectedColorIndex = 0;
    let selectedDifficultyIndex = 1; // Start with Medium

    let snake = [];
    let direction = Direction.RIGHT;
    let nextDirection = Direction.RIGHT;

    let currentPowerup = POWERUP_TYPES.FOOD;
    let powerupPos = null;

    let score = 0;
    const baseSpeed = 10;
    let currentSpeed = baseSpeed;
    let speedBoostEndTime = 0;

    let gameOver = false;
    let lastStepTime = 0;
    
    // Countdown state
    let inCountdown = false;
    let countdownNumber = 3;
    let countdownStartTime = 0;
    let countdownScale = 1;

    // Music
    let bgMusic = null;
    let musicLoaded = false;
    let userInteracted = false;
    try {
      bgMusic = new Audio("background_music.mp3");
      bgMusic.loop = true;
      musicLoaded = true;
    } catch (e) {
      musicLoaded = false;
    }

    function toggleMusic() {
      if (!bgMusic || !musicLoaded) return;
      if (bgMusic.paused) {
        bgMusic.play().catch(() => {});
      } else {
        bgMusic.pause();
      }
    }

    // ==== HELPERS ====
    function randomEmptyCell() {
      while (true) {
        const x = Math.floor(Math.random() * GRID_SIZE);
        const y = Math.floor(Math.random() * GRID_SIZE);
        if (!snake.some(seg => seg.x === x && seg.y === y)) {
          return { x, y };
        }
      }
    }

    function spawnItem() {
      powerupPos = randomEmptyCell();
    }

    function spawnNewPowerup() {
      const difficultyId = DIFFICULTIES[selectedDifficultyIndex].id;
      let possible = [];

      if (difficultyId === "EASY") {
        currentPowerup = POWERUP_TYPES.FOOD;
        spawnItem();
        return;
      } else if (difficultyId === "MEDIUM") {
        possible = [
          POWERUP_TYPES.FOOD,
          POWERUP_TYPES.SPEED_UP,
          POWERUP_TYPES.SLOW_DOWN,
          POWERUP_TYPES.DOUBLE_GROWTH
        ];
      } else {
        possible = [
          POWERUP_TYPES.FOOD,
          POWERUP_TYPES.SPEED_UP,
          POWERUP_TYPES.TELEPORT,
          POWERUP_TYPES.SLOW_DOWN,
          POWERUP_TYPES.DOUBLE_GROWTH
        ];
      }

      currentPowerup = possible[Math.floor(Math.random() * possible.length)];
      spawnItem();
    }

    function getPowerupColor() {
      if (currentPowerup === POWERUP_TYPES.FOOD) return rgb(COLORS.RED);
      if (currentPowerup === POWERUP_TYPES.SPEED_UP) return rgb(COLORS.PURPLE);
      if (currentPowerup === POWERUP_TYPES.TELEPORT) return rgb(COLORS.LIGHT_GREEN);
      if (currentPowerup === POWERUP_TYPES.SLOW_DOWN) return rgb(COLORS.YELLOW);
      if (currentPowerup === POWERUP_TYPES.DOUBLE_GROWTH) return rgb(COLORS.BLUE);
      return rgb(COLORS.RED);
    }

    // ==== GAME SETUP ====
    function startCountdown() {
      inSelectionScreen = false;
      inCountdown = true;
      countdownNumber = 3;
      countdownStartTime = performance.now();
      countdownScale = 1;
    }
    
    function startGame() {
      const startX = Math.floor(GRID
